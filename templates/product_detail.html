{% extends "base.html" %}
{% block content %}

<!-- ==========================================================
     PAGE-SPECIFIC STYLES
     Loads CSS only for the product detail page.
========================================================== -->
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/product_detail.css') }}">
{% endblock %}

<!-- Font Awesome (for star icons) -->
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer" />



<!-- ==========================================================
     PRODUCT TOP SECTION — GALLERY + DETAILS
========================================================== -->
<div class="container luxury">
  <div class="lux-row">

    <!-- ======================================================
         LEFT SIDE — PRODUCT IMAGE GALLERY
         Contains:
           - Main image slider
           - Prev/Next controls
           - Thumbnail row
    ======================================================= -->
    <div class="lux-left">
      <div class="gallery-card">

        <!-- Main image + navigation arrows -->
        <div class="gallery-main" id="galleryMain">
          <img id="mainImage"
               src="{{ url_for('static', filename='images/products/' ~ product.image) }}">
          <button class="gallery-nav gallery-prev" id="btnPrev">❮</button>
          <button class="gallery-nav gallery-next" id="btnNext">❯</button>
        </div>

        <!-- Thumbnail images -->
        <div class="thumb-row">
          {% set images = [] %}
          {% if product.image %}{% set images = images + [product.image] %}{% endif %}
          {% if product.image2 %}{% set images = images + [product.image2] %}{% endif %}
          {% if product.image3 %}{% set images = images + [product.image3] %}{% endif %}

          {% for img in images %}
            <img class="thumb {% if loop.first %}active{% endif %}"
                 src="{{ url_for('static', filename='images/products/' ~ img) }}">
          {% endfor %}
        </div>

      </div>
    </div>



    <!-- ======================================================
         RIGHT SIDE — PRODUCT DETAILS
         Includes name, rating, pricing, variants, highlights,
         specifications, and add-to-cart form.
    ======================================================= -->
    <div class="lux-right">
      <div class="product-card">

        <!-- Title -->
        <div class="prod-title">{{ product.name }}</div>

        <!-- Rating summary -->
        {% if avg_rating %}
        <div class="mt-2">
          <span class="pd-rating-badge">{{ avg_rating }} ★</span>
          <small class="ms-2 text-muted">{{ review_count }} reviews</small>
        </div>
        {% endif %}

        <!-- Pricing -->
        <div class="price-row">
          <div class="price-current">₹{{ product.price }}</div>

          {% if mrp %}
          <div class="price-mrp">₹{{ mrp }}</div>
          <div class="price-save">Save ₹{{ mrp - product.price }}</div>
          {% endif %}
        </div>

        <!-- Description -->
        <p class="text-muted mt-2">{{ product.description or '' }}</p>

        <!-- ==================================================
             SIZE & COLOR SELECTORS
             Only displayed for non-cosmetic categories.
        =================================================== -->
        {% if product.category != 'cosmetics' %}

          {% if product.sizes %}
          <div class="section-title mt-3">Select Size</div>
          <div class="selector-row" id="sizeList">
            {% for s in product.sizes %}
            <div class="size-pill" data-size="{{ s }}">{{ s }}</div>
            {% endfor %}
          </div>
          {% endif %}

          {% if product.colors %}
          <div class="section-title mt-3">Colors</div>
          <div class="selector-row" id="colorList">
            {% for c in product.colors %}
            <div class="color-dot" style="background:'{{ c }}'"></div>
            {% endfor %}
          </div>
          {% endif %}

        {% endif %}


        <!-- ==================================================
             ADD TO CART FORM
             Sends:
               - product_id
               - selected size/color
               - quantity
        =================================================== -->
        <form action="{{ url_for('product.add_to_cart') }}" method="POST">
          <input type="hidden" name="product_id" value="{{ product._id|string }}">
          <input type="hidden" name="selected_size" id="selectedSize">
          <input type="hidden" name="selected_color" id="selectedColor">

          <div class="add-row">
            <input type="number" class="form-control"
                   name="quantity" value="1" min="1" style="width:90px;">
            <button class="add-btn" id="addBtn" disabled>ADD TO CART</button>
          </div>
        </form>


        <!-- Product Highlights List -->
        {% if product.highlights %}
        <div class="section-title mt-4">Product Highlights</div>
        <ul class="highlights">
          {% for h in product.highlights %}
          <li>⭐ {{ h }}</li>
          {% endfor %}
        </ul>
        {% endif %}

        <!-- Specifications Table -->
        {% if product.details and product.details.items %}
        <div class="section-title mt-4">Specifications</div>
        <table class="table specs-table">
          <tbody>
            {% for k, v in product.details.items() %}
            <tr>
              <th>{{ k }}</th>
              <td>{{ v }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}

      </div>
    </div>

  </div>
</div>



<!-- ==========================================================
     REVIEWS SECTION — Ratings Breakdown + Review List + Forms
========================================================== -->
<div class="container luxury mt-5">
  <div class="reviews-block">

    <h3 class="section-title">Customer Reviews</h3>

    <!-- ================================================
         RATING BREAKDOWN
         Avoids counting same user multiple times.
    ================================================= -->
    {% set seen_users = [] %}
    {% set counts = [0,0,0,0,0] %}

    {% for r in reviews %}
      {% set rating_value = r["rating"] | int %}
      {% if 1 <= rating_value <= 5 %}
        {% if r["user"] not in seen_users %}
          {% set index = rating_value - 1 %}
          {% set counts = counts[:index] + [counts[index] + 1] + counts[index+1:] %}
          {% set seen_users = seen_users + [r["user"]] %}
        {% endif %}
      {% endif %}
    {% endfor %}

    {% set total = counts | sum %}

    <!-- Rating Bars + Average -->
    <div class="breakdown mt-3">

      <!-- Average Score -->
      <div class="avg">
        <div class="value">{{ avg_rating or 0 }}</div>
        <div class="small-muted">{{ total }} review{{ 's' if total != 1 }}</div>
      </div>

      <!-- Per-star bars -->
      <div style="flex:1">
        {% for star in range(5,0,-1) %}
        {% set idx = star - 1 %}
        {% set cnt = counts[idx] %}
        {% set pct = total > 0 and ((cnt * 100) / total) or 0 %}
        <div class="bar-row">
          <div>{{ star }}★</div>
          <div class="bar-track">
            <div class="bar-fill" data-pct="{{ pct }}"></div>
          </div>
          <div style="width:40px; text-align:right;">{{ cnt }}</div>
        </div>
        {% endfor %}
      </div>

    </div>



    <!-- ================================================
         LIST OF REVIEWS (1 per user)
    ================================================= -->
    {% set shown_users = [] %}
    {% for r in reviews %}
      {% if r["user"] not in shown_users %}

      <!-- Single Review Card -->
      <div class="review-card mt-3" id="review-{{ r['_id'] }}">

        <div style="max-width:80%;">
          <span class="review-user">{{ r["user"] }}</span>
          <span class="review-stars">{{ r["rating"] }} ★</span>

          <div class="text-muted" style="font-size:12px;">
            {% if r.get("updated_at") %}
            Updated {{ r["updated_at"].strftime('%Y-%m-%d') }}
            {% elif r.get("created_at") %}
            Posted {{ r["created_at"].strftime('%Y-%m-%d') }}
            {% endif %}
          </div>

          <p class="mt-2">{{ r["review"] }}</p>
        </div>

        <!-- Edit/Delete options for the review owner -->
        {% if session.get('user') == r["user"] %}
        <div>
          <button class="btn btn-outline-primary btn-sm edit-btn"
                  data-id="{{ r['_id'] }}">Edit</button>

          <form action="{{ url_for('review.delete_review',
                    review_id=r['_id']|string,
                    product_id=product._id|string) }}"
                method="POST"
                style="display:inline;">
            <button class="btn btn-outline-danger btn-sm">Delete</button>
          </form>
        </div>
        {% endif %}

      </div>


      <!-- Inline Review Edit Form (Hidden by default) -->
      <div class="review-edit" id="edit-{{ r['_id'] }}">
        <form method="POST"
              action="{{ url_for('review.add_review',
                                 product_id=product._id|string) }}">

          <input type="hidden" name="review_id" value="{{ r['_id']|string }}">
          <input type="hidden" name="rating"
                 class="edit-rating"
                 value="{{ r['rating'] | int }}">

          <!-- Edit Star Rating -->
          <div class="star-row edit-stars">
            {% for s in range(1,6) %}
            <i class="fa fa-star edit-star
                 {% if s <= (r['rating']|int) %}active{% endif %}"
               data-value="{{ s }}"></i>
            {% endfor %}
          </div>

          <!-- Edit Review Text -->
          <textarea name="review" class="form-control mt-2"
                    rows="3">{{ r["review"] }}</textarea>

          <div class="mt-2">
            <button type="submit" class="btn btn-dark btn-sm">Save</button>
            <button type="button"
                    class="btn btn-secondary btn-sm cancel-edit"
                    data-id="{{ r['_id'] }}">Cancel</button>
          </div>
        </form>
      </div>


      {% set shown_users = shown_users + [r["user"]] %}
      {% endif %}
    {% endfor %}



    <!-- ================================================
         REVIEW FORM FOR NEW REVIEWERS
         Only shown if:
           - user is logged in
           - user has NOT already reviewed this product
    ================================================= -->
    {% if session.get('user') %}

      {% set user_review = None %}
      {% for rr in reviews %}
        {% if rr["user"] == session.get('user') %}
          {% set user_review = rr %}
        {% endif %}
      {% endfor %}

      {% if not user_review %}
      <form method="POST"
            class="review-form mt-4"
            action="{{ url_for('review.add_review',
                               product_id=product._id|string) }}">

        <!-- Star Rating Selector -->
        <label>Your Rating</label>
        <div class="star-row new-stars mt-1">
          {% for s in range(1,6) %}
          <i class="fa fa-star new-star" data-value="{{ s }}"></i>
          {% endfor %}
        </div>

        <!-- Hidden input storing selected rating -->
        <input type="hidden" name="rating" id="newRating" required>

        <!-- Review Text -->
        <label class="mt-2">Write a Review</label>
        <textarea name="review" class="form-control"
                  rows="4" required></textarea>

        <div class="mt-2">
          <button class="btn btn-dark">Submit Review</button>
        </div>
      </form>

      {% else %}
      <p class="text-muted mt-4">
        You already reviewed this product. Use Edit above.
      </p>
      {% endif %}

    {% endif %}

  </div>
</div>



<!-- ==========================================================
     PAGE-SPECIFIC SCRIPTS
========================================================== -->
{% block scripts %}
<script src="{{ url_for('static', filename='js/product_detail.js') }}"></script>
{% endblock %}

{% endblock %}
